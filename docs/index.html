<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>量子 1‑Shot 投票 & 即時統計 (H / Bell)</title>
  <!-- ===== 說明 =====
    這是一個單檔版的「1-shot 即時投票」網頁：
    - 以 URL 參數 ?role=host 進入主持人/看板模式（即時統計畫面）
    - 以 URL 參數 ?role=student 進入學生模式（單次作答、巨大按鈕）
    - 以 URL 參數 ?session=ABC 指定場次代碼（同一堂課用同一個 session）

    實作採用 Firebase Realtime Database：
    - 你需要替換下方 window.FIREBASE_CONFIG，填入自己的 Firebase 專案設定。
    - Database 規則請在課堂前設定（範例規則附在最下方註解）。

    操作流程（H gate 範例）
    1) 老師：開 host 視圖，例如 https://你的域名/index.html?role=host&session=H-coin
    2) 學生：掃投影上的 QR，打開 https://你的域名/index.html?role=student&session=H-coin
       - 每位學生在 IBM Quantum Composer 跑 1-shot 後，
         點擊自己觀察到的輸出（0 或 1）的巨大按鈕送出。
       - 系統限制「一機一票」（以 localStorage 簽名；可配合課堂規範）。
    3) 主持人畫面即時顯示 0/1 數量與比例長條圖。

    Bell 狀態範例
    - 發給配對好的 A/B 學生同一個 session，例如 session=BELL-1。
    - 兩人只需讓其中一人送出聯合結果（00 / 11 / 01 / 10）。
      （或開四鍵學生介面、口頭協作決定勾選哪個）

    你也可以用同一份檔案進行多輪：每一輪換一個 session 代碼即可。
  ===== -->
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; margin: 0; padding: 16px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { margin: 0 0 8px; }
    .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 280px; }
    .big-btn { font-size: 28px; padding: 20px; width: 100%; border-radius: 16px; border: 1px solid #d1d5db; cursor: pointer; }
    .big-btn:disabled { opacity: .5; cursor: not-allowed; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #f3f4f6; }
    .muted { color: #6b7280; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    canvas { width: 100%; height: 300px; border: 1px dashed #e5e7eb; border-radius: 8px; }
    .bar { height: 28px; background: #e5e7eb; border-radius: 999px; position: relative; overflow: hidden; }
    .fill { position: absolute; left: 0; top: 0; bottom: 0; background: #60a5fa; }
    .bar-label { position: absolute; left: 12px; top: 4px; font-weight: 600; }
  </style>
</head>
<body>
<div class="container">
  <h1>量子 1‑Shot 投票 & 即時統計</h1>
  <div class="muted">用於 H 門（0/1）與 Bell（00/11/01/10）一鍵回報、班級即時統計。</div>
  <hr />

  <div id="app" class="card"></div>
</div>

<script>
  // === 1) URL 參數解析 ===
  const params = new URLSearchParams(location.search);
  const ROLE = params.get('role') || 'student'; // 'host' | 'student'
  const SESSION = params.get('session') || 'DEMO';

  // === 2) Firebase 設定（請替換） ===
  window.FIREBASE_CONFIG = {
    apiKey: "AIzaSyAZ_L6ru1tKWsB68pzwln-K7lB4xvMIpYE",
    authDomain: "quantumcircuitvote-b4d42.firebaseapp.com",
    projectId: "quantumcircuitvote-b4d42",
    storageBucket: "quantumcircuitvote-b4d42.firebasestorage.app",
    messagingSenderId: "886833352301",
    appId: "1:886833352301:web:8ffb9428151495dfaaf964",
    databaseURL: "https://quantumcircuitvote-b4d42-default-rtdb.firebaseio.com",
  };
</script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script>
  // === 3) 初始化 Firebase ===
  firebase.initializeApp(window.FIREBASE_CONFIG);
  const db = firebase.database();

  // 資料結構：/sessions/{SESSION}/counts/{key} -> number
  // 例如 H：key in {"0","1"}；Bell：key in {"00","11","01","10"}

  // 小工具
  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={}, children=[]) => {
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v]) => {
      if (k === 'class') n.className = v; else if (k === 'onclick') n.onclick = v; else n.setAttribute(k, v);
    });
    children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
    return n;
  };

  // 一機一票（localStorage 簽名）
  const VOTE_KEY = `quantum-vote:${SESSION}`;
  const hasVoted = () => localStorage.getItem(VOTE_KEY) === '1';
  const markVoted = () => localStorage.setItem(VOTE_KEY, '1');
  const clearVotes = () => localStorage.removeItem(VOTE_KEY);

  // 寫票：原子加 1
  async function castVote(key) {
    const ref = db.ref(`/sessions/${SESSION}/counts/${key}`);
    await ref.transaction(v => (v||0) + 1);
  }

  // 清場次（主持人功能）
  async function resetSession() {
    await db.ref(`/sessions/${SESSION}`).remove();
  }

  // 讀取 counts 並即時更新
  function onCounts(cb) {
    db.ref(`/sessions/${SESSION}/counts`).on('value', snap => cb(snap.val() || {}));
  }

  // === 4) UI ===
  const app = $('#app');

  function renderStudent() {
    const title = el('div', {}, [
      el('div', {class:'pill'}, [ `模式：學生` ]),
      el('h2', {}, [ `場次：${SESSION}` ])
    ]);

    // 兩組版面：
    const hPanel = el('div', {class:'col card'}, [
      el('h3', {}, [ 'H 門：選擇你量到的結果（1 次）' ]),
      el('div', {class:'grid-2'}, [
        el('button', {class:'big-btn', id:'btn-0', onclick: async ()=>voteOnce('0')}, ['0']),
        el('button', {class:'big-btn', id:'btn-1', onclick: async ()=>voteOnce('1')}, ['1'])
      ])
    ]);

    const bellPanel = el('div', {class:'col card'}, [
      el('h3', {}, [ 'Bell：請其中 1 人回報聯合結果（1 次）' ]),
      el('div', {class:'grid-4'}, [
        el('button', {class:'big-btn', id:'btn-00', onclick: async ()=>voteOnce('00')}, ['00']),
        el('button', {class:'big-btn', id:'btn-11', onclick: async ()=>voteOnce('11')}, ['11']),
        el('button', {class:'big-btn', id:'btn-01', onclick: async ()=>voteOnce('01')}, ['01']),
        el('button', {class:'big-btn', id:'btn-10', onclick: async ()=>voteOnce('10')}, ['10'])
      ])
    ]);

    const tip = el('div', {class:'muted', style:'margin-top:8px'}, [
      '系統會以本機瀏覽器限制單次作答；若誤觸需重送，請告知老師在主持人端重置此場次。'
    ]);

    const wrapper = el('div', {class:'row'}, [ hPanel, bellPanel ]);
    app.innerHTML = '';
    app.appendChild(title);
    app.appendChild(wrapper);
    app.appendChild(tip);

    updateButtons();
  }

  async function voteOnce(key) {
    if (hasVoted()) { alert('本機已送出過一次。'); return; }
    try {
      await castVote(key);
      markVoted();
      updateButtons();
      alert('已送出！');
    } catch (e) {
      console.error(e); alert('送出失敗，請再試一次或通知老師。');
    }
  }

  function updateButtons() {
    const disabled = hasVoted();
    ['0','1','00','11','01','10'].forEach(k => {
      const btn = document.getElementById(`btn-${k}`);
      if (btn) btn.disabled = disabled;
    });
  }

  function renderHost() {
    const title = el('div', {}, [
      el('div', {class:'pill'}, [ `模式：主持人` ]),
      el('h2', {}, [ `場次：${SESSION}` ]),
      el('div', {class:'muted'}, [ '即時統計。右上可重置本場次（清零）。' ])
    ]);

    const resetBtn = el('button', {class:'big-btn', onclick: async ()=>{ if(confirm('清空本場次所有票數？')) await resetSession(); }}, ['重置本場次']);

    const board = el('div', {class:'row'});

    function drawBars(counts, keys, titleText) {
      const total = keys.reduce((s,k)=>s+(counts[k]||0), 0);
      const wrap = el('div', {class:'col card'}, [ el('h3', {}, [titleText, ' ', el('span',{class:'muted'},[`（合計 ${total} ）`]) ]) ]);
      keys.forEach(k => {
        const v = counts[k] || 0;
        const p = total ? Math.round(v*100/total) : 0;
        const bar = el('div', {class:'bar', style:'margin:8px 0;'}, [
          el('div', {class:'fill', style:`width:${p}%;`}),
          el('div', {class:'bar-label'}, [ `${k} — ${v}（${p}%）` ])
        ]);
        wrap.appendChild(bar);
      });
      return wrap;
    }

    app.innerHTML = '';
    app.appendChild(title);
    app.appendChild(resetBtn);
    app.appendChild(board);

    onCounts(counts => {
      board.innerHTML = '';
      // H 視圖
      board.appendChild(drawBars(counts, ['0','1'], 'H 門：0/1 分佈'));
      // Bell 視圖
      board.appendChild(drawBars(counts, ['00','11','01','10'], 'Bell：聯合輸出分佈'));
    });
  }

  if (ROLE === 'host') renderHost(); else renderStudent();
</script>

<!-- ===== Firebase Realtime Database 規則（示例，請視安全需求調整） =====
{
  "rules": {
    "sessions": {
      "$session": {
        ".read": true,
        "counts": {
          "$key": {
            ".write": true,              // 課堂公開投票，允許匿名寫入指定 path
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        }
      }
    }
  }
}
註：正式課程建議額外加入簡單防刷：
- 在客戶端用 localStorage 鎖一票（已實作）
- 於規則層做節流：限制每個 IP 或以 Firebase Auth 匿名登入後，限制 UID 可寫入次數（進階）
- 主持端可視情況重置（本檔已提供 resetSession）
-->

</body>
</html>
